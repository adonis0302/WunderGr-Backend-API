name: Engine Release Preview
on:
  push:
    branches:
      - '**'
    paths-ignore:
      - 'docs*/**'
      - '*.md'

env:
  WORKING_DIRECTORY: '.'
  CI: true

# trigger
jobs:
  engine-release-summary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: ./.github/actions/go
        with:
          working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Install Protoc
        uses: arduino/setup-protoc@v1
        with:
          version: '3.x'
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: generate go types based on protobuf definitions
        run: make codegen-go

      - name: Generate Release summary with GoReleaser
        uses: goreleaser/goreleaser-action@v3
        with:
          version: latest
          workdir: './cmd/wunderctl'
          distribution: goreleaser-pro
          args: changelog --config ./../../.github/goreleaser/.goreleaser-linux.yml -o release-summary
        env:
          # custom PAT to push in https://github.com/wundergraph/homebrew-wundergraph
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN_GORELEASER }}
          GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}

      - name: Export release summary
        working-directory: './cmd/wunderctl'
        run: export GITHUB_STEP_SUMMARY=$(cat release-summary)
